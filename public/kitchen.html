<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kitchen Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#0f0f0f;
  color:#fff;
}

header{
  background:#111;
  padding:16px;
  font-size:26px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  padding:8px 14px;
  border-radius:20px;
  border:none;
  cursor:pointer;
  font-size:14px;
}

.logout{background:#e74c3c;color:#fff}

#orders{
  padding:16px;
}

.card{
  background:#1e1e1e;
  border-left:8px solid #f39c12;
  border-radius:16px;
  padding:16px;
  margin-bottom:18px;
  animation:fade .3s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1}
}

.accepted{border-left-color:#3498db}
.ready{border-left-color:#2ecc71}
.cancelled{border-left-color:#e74c3c;opacity:.6}

.items{margin:10px 0}
.meta{
  font-size:13px;
  opacity:.8;
  margin-top:6px;
}

.actions button{
  margin-top:10px;
  width:48%;
}

.accept{background:#3498db;color:#fff}
.readyBtn{background:#2ecc71;color:#000}

.complaint{
  margin-top:10px;
  background:#2c0000;
  padding:10px;
  border-radius:10px;
  color:#ffb3b3;
}

textarea{
  width:100%;
  margin-top:8px;
  padding:8px;
  border-radius:10px;
  border:none;
}
</style>
</head>

<body>

<header>
  üç≥ Kitchen Dashboard
  <button class="logout" onclick="logout()">Logout</button>
</header>

<div id="orders">Loading orders‚Ä¶</div>

<script>
const box = document.getElementById("orders");

function logout(){
  fetch("/logout",{method:"POST",credentials:"same-origin"})
    .then(()=>location.href="/login.html");
}

function loadOrders(){
  fetch("/orders",{credentials:"same-origin"})
    .then(r=>{
      if(!r.ok) throw new Error("unauthorized");
      return r.json();
    })
    .then(list=>{
      box.innerHTML="";
      if(!list.length){
        box.innerHTML="<h3>No orders yet</h3>";
        return;
      }

      list.forEach(o=>{
        const div=document.createElement("div");

        div.className=
          "card "+
          (o.status==="Accepted"?"accepted ":"")+
          (o.status==="Ready"?"ready ":"")+
          (o.cancelled?"cancelled":"");

        const items=JSON.parse(o.items||"[]")
          .map(i=>`${i.name} √ó ${i.qty}`).join("<br>");

        div.innerHTML=`
          <h3>Table ${o.table_no}</h3>
          <div class="meta">Date: ${o.date || "-"} | Time: ${o.time || "-"}</div>
          <div class="items">${items}</div>
          <div>Total ‚Çπ${o.total}</div>
          <div>Status: <b>${o.status}</b></div>

          ${o.complaint ? `
            <div class="complaint">
              üí¨ ${o.complaint}
              <textarea id="r${o.id}" placeholder="Reply to customer"></textarea>
              <button onclick="reply(${o.id})">Reply</button>
            </div>`:""}

          <div class="actions">
            ${o.status==="Pending" && !o.cancelled
              ? `<button class="accept" onclick="setStatus(${o.id},'Accepted')">Accept</button>`:""}
            ${o.status==="Accepted"
              ? `<button class="readyBtn" onclick="setStatus(${o.id},'Ready')">Ready</button>`:""}
          </div>
        `;

        box.appendChild(div);
      });
    })
    .catch(err=>{
      if(err.message==="unauthorized"){
        box.innerHTML="<h3>Login required. Please login again.</h3>";
        setTimeout(()=>location.href="/login.html",1200);
      }else{
        box.innerHTML="<h3>Server error. Please refresh.</h3>";
      }
    });
}

function setStatus(id,status){
  fetch("/order/status",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials:"same-origin",
    body:JSON.stringify({id,status})
  }).then(loadOrders);
}

function reply(id){
  const text=document.getElementById("r"+id).value;
  if(!text)return;
  fetch("/order/reply",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials:"same-origin",
    body:JSON.stringify({id,reply:text})
  }).then(loadOrders);
}

loadOrders();
setInterval(loadOrders,3000);
</script>

</body>
</html>
