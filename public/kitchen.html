<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kitchen Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --card:#111;
  --pending:#f39c12;
  --accepted:#3498db;
  --ready:#2ecc71;
  --danger:#e74c3c;
}

body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:radial-gradient(circle at top,#111,#000);
  color:#fff;
}

header{
  background:#0c0c0c;
  padding:18px 26px;
  font-size:28px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header button{
  background:#222;
  color:#fff;
  border:none;
  border-radius:20px;
  padding:8px 16px;
  font-size:16px;
  cursor:pointer;
}

#orders{
  height:calc(100vh - 90px);
  overflow-y:auto;
  padding:24px;
}

.placeholder{
  text-align:center;
  font-size:26px;
  opacity:.6;
  margin-top:20vh;
}

.order{
  background:var(--card);
  border-left:10px solid var(--pending);
  border-radius:18px;
  padding:20px;
  margin-bottom:24px;
  animation:fadeIn .25s ease;
}

.order.accepted{border-left-color:var(--accepted)}
.order.ready{border-left-color:var(--ready)}
.order.cancelled{border-left-color:var(--danger);opacity:.6}
.order.delayed{
  border-left-color:var(--danger);
  box-shadow:0 0 30px rgba(231,76,60,.9);
  animation:pulse 1.4s infinite;
}

@keyframes pulse{
  0%{box-shadow:0 0 10px rgba(231,76,60,.4)}
  100%{box-shadow:0 0 30px rgba(231,76,60,1)}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.badge{
  font-size:14px;
  padding:6px 14px;
  border-radius:16px;
}
.paid{background:var(--ready);color:#000}
.unpaid{background:var(--danger)}

.items{margin:12px 0;line-height:1.6}

.actions button{
  margin-top:10px;
  padding:8px 16px;
  font-size:15px;
  border-radius:20px;
  border:none;
  cursor:pointer;
}
.accept{background:var(--accepted);color:#fff}
.readyBtn{background:var(--ready);color:#000;margin-left:10px}

.complaint{
  margin-top:12px;
  padding:12px;
  background:#2c0000;
  border-left:6px solid var(--danger);
  color:#ffb3b3;
}

textarea{
  width:100%;
  margin-top:8px;
  padding:8px;
  border-radius:8px;
  border:none;
}

.replyBtn{
  margin-top:6px;
  background:#3498db;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:14px;
  cursor:pointer;
}

.eta.warn{color:#f1c40f}
.eta.danger{color:#e74c3c;font-weight:bold}
</style>
</head>

<body>

<header>
  üç≥ Kitchen Live Orders
  <div>
    <button onclick="toggleLang()">üîä <span id="lang">EN</span></button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div id="orders">
  <div class="placeholder" id="empty">No orders yet üçΩ</div>
</div>

<audio id="newSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="acceptSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="readySound" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

<script>
const ordersBox = document.getElementById("orders");
const empty = document.getElementById("empty");

const newSound = document.getElementById("newSound");
const acceptSound = document.getElementById("acceptSound");
const readySound = document.getElementById("readySound");

let knownStatus = {};
let lang = "EN";

function logout(){
  fetch("/logout",{method:"POST"}).then(()=>location.href="/login.html");
}

function toggleLang(){
  lang = lang==="EN"?"TE":"EN";
  document.getElementById("lang").innerText = lang;
}

function speak(en,te){
  if(!("speechSynthesis" in window))return;
  speechSynthesis.speak(
    new SpeechSynthesisUtterance(lang==="EN"?en:te)
  );
}

function getItems(order){
  try{
    const p = JSON.parse(order.items);
    return Array.isArray(p)?p:Object.values(p);
  }catch{return [];}
}

function calcETA(order){
  return 8 + getItems(order).reduce((s,i)=>s+i.qty,0)*2;
}

function isDelayed(order){
  return Date.now() - new Date(order.date+" "+order.time).getTime()
    > calcETA(order)*60000;
}

async function loadOrders(){
  const res = await fetch("/orders",{credentials:"same-origin"});
  const orders = await res.json();

  ordersBox.innerHTML="";
  if(!orders.length){
    ordersBox.appendChild(empty);
    return;
  }

  orders.forEach(order=>{
    const delayed=isDelayed(order);
    const div=document.createElement("div");

    div.className="order "+
      (order.status==="Accepted"?"accepted ":"")+
      (order.status==="Ready"?"ready ":"")+
      (order.cancelled?"cancelled ":"")+
      (delayed?"delayed":"");

    div.innerHTML=`
      <h3>
        Table ${order.table_no}
        <span class="badge ${order.payment==='UPI'?'paid':'unpaid'}">
          ${order.payment}
        </span>
      </h3>

      <div class="items">
        ${getItems(order).map(i=>`${i.name} √ó ${i.qty}`).join("<br>")}
      </div>

      <div>üë§ ${order.customer_name||"Guest"}</div>
      <div>üìû ${order.customer_phone||"-"}</div>
      <div>üïí ${order.date} ${order.time}</div>
      <div>Total ‚Çπ${order.total}</div>

      <div class="eta ${delayed?'danger':'warn'}">
        ETA ~${calcETA(order)} min ${delayed?'‚è∞ DELAYED':''}
      </div>

      ${order.complaint?`
        <div class="complaint">
          üí¨ ${order.complaint}
          <textarea id="reply-${order.id}" placeholder="Reply to customer"></textarea>
          <button class="replyBtn" onclick="sendReply(${order.id})">Reply</button>
        </div>`:""}

      <div class="actions">
        ${order.status==="Pending" && !order.cancelled
          ? `<button class="accept" onclick="setStatus(${order.id},'Accepted')">Accept</button>`:""}
        ${order.status!=="Ready" && !order.cancelled
          ? `<button class="readyBtn" onclick="setStatus(${order.id},'Ready')">Ready</button>`:""}
      </div>
    `;

    ordersBox.appendChild(div);

    if(!knownStatus[order.id]){
      knownStatus[order.id]=order.status;
      newSound.play();
      speak(`New order from table ${order.table_no}`,
            `‡∞ü‡±á‡∞¨‡±Å‡∞≤‡±ç ${order.table_no} ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç`);
    }else if(knownStatus[order.id]!==order.status){
      knownStatus[order.id]=order.status;
      if(order.status==="Accepted"){acceptSound.play();}
      if(order.status==="Ready"){readySound.play();}
    }
  });
}

function setStatus(id,status){
  fetch("/order/status",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({id,status})
  }).then(loadOrders);
}

function sendReply(id){
  const el=document.getElementById("reply-"+id);
  if(!el||!el.value.trim()) return;

  fetch("/order/reply",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    credentials:"same-origin",
    body:JSON.stringify({id,reply:el.value})
  }).then(()=>{el.value="";loadOrders();});
}

loadOrders();
setInterval(loadOrders,3000);
</script>

</body>
</html>
