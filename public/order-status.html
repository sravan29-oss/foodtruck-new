<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#0f0f0f;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.card{
  background:#1c1c1c;
  width:92%;
  max-width:420px;
  border-radius:18px;
  padding:20px;
  animation:fade .4s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1}
}

h2{text-align:center;margin-bottom:8px}

.status{
  text-align:center;
  font-size:22px;
  margin:10px 0;
}

.pending{color:#f1c40f}
.accepted{color:#3498db}
.ready{color:#2ecc71}
.cancelled{color:#e74c3c}

.items{
  background:#111;
  border-radius:12px;
  padding:12px;
  margin:12px 0;
  font-size:15px;
}

button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:22px;
  font-size:16px;
  cursor:pointer;
}

.cancel{background:#e74c3c;color:#fff}
.edit{background:#f39c12;color:#000}
.send{background:#3498db;color:#fff}

textarea{
  width:100%;
  border-radius:14px;
  padding:10px;
  border:none;
  margin-top:8px;
  font-size:15px;
}

.reply{
  background:#003300;
  color:#9aff9a;
  padding:10px;
  border-radius:12px;
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card" id="box">
  Loading order‚Ä¶
</div>

<script>
const qs = new URLSearchParams(location.search);
const id = qs.get("id");
const apiParam = qs.get("api");

// Use ?api=YOUR_BACKEND_URL if frontend and backend are different
const API_BASE = apiParam ? decodeURIComponent(apiParam) : location.origin;

const box = document.getElementById("box");

function renderError(msg){
  box.innerHTML = `<h3 style="text-align:center">${msg}</h3>`;
}

async function fetchOrder(){
  if(!id){
    renderError("Order ID missing");
    return null;
  }

  // Try /order/:id first
  let res = await fetch(`${API_BASE}/order/${id}`).catch(()=>null);
  if(!res || !res.ok){
    // Fallback: /order?id=
    res = await fetch(`${API_BASE}/order?id=${id}`).catch(()=>null);
  }
  if(!res || !res.ok){
    renderError("Order not found or server not reachable");
    return null;
  }

  const data = await res.json().catch(()=>null);
  if(!data || !data.id){
    renderError("Invalid order data");
    return null;
  }

  return data;
}

/* LOAD STATUS */
async function loadStatus(){
  const o = await fetchOrder();
  if(!o) return;

  const statusText = o.status || "Pending";

  let statusClass =
    statusText==="Pending" ? "pending" :
    statusText==="Accepted" ? "accepted" :
    statusText==="Ready" ? "ready" :
    statusText==="Cancelled" ? "cancelled" : "";

  const items = JSON.parse(o.items || "[]")
    .map(i=>`${i.name} √ó ${i.qty}`)
    .join("<br>");

  const canCancel =
    statusText==="Pending" &&
    Date.now() < (o.can_modify_until || 0);

  box.innerHTML=`
    <h2>Order #${o.id}</h2>

    <div class="status ${statusClass}">
      ${statusText}
    </div>
    <div>Date: ${o.date || "-"} | Time: ${o.time || "-"}</div>

    <div class="items">
      ${items || "No items"}
      <hr>
      <b>Total ‚Çπ${o.total || 0}</b>
    </div>

    <div>üë§ ${o.customer_name || "-"}</div>
    <div>üìû ${o.customer_phone || "-"}</div>

    ${o.kitchen_reply ? `
      <div class="reply">
        üç≥ Kitchen: ${o.kitchen_reply}
      </div>
    ` : ""}

    ${canCancel ? `
      <button class="cancel" onclick="cancelOrder()">
        ‚ùå Cancel Order
      </button>
      <button class="edit" onclick="editOrder()">
        ‚úèÔ∏è Edit Order
      </button>
    ` : ""}

    <textarea id="complaint"
      placeholder="Any issue or delay complaint?"></textarea>

    <button class="send" onclick="sendComplaint()">
      üí¨ Send Complaint
    </button>
  `;
}

/* CANCEL */
function cancelOrder(){
  fetch(`${API_BASE}/order/cancel`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id})
  }).then(loadStatus);
}

/* EDIT */
function editOrder(){
  alert("Edit allowed before accept.\nPlease reorder from menu.");
  location.href = "/";
}

/* COMPLAINT */
function sendComplaint(){
  const text=document.getElementById("complaint").value.trim();
  if(!text)return alert("Enter complaint");

  fetch(`${API_BASE}/order/complaint`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id,text})
  }).then(()=>{
    alert("Complaint sent");
    document.getElementById("complaint").value="";
    loadStatus();
  });
}

loadStatus();
setInterval(loadStatus,3000);
</script>

</body>
</html>
