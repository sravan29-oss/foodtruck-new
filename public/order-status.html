<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@import url("https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Inter:wght@400;500;600&display=swap");

:root{
  --bg:#0b0d12;
  --card:#131826;
  --text:#f5f7fb;
  --muted:#aab4c6;
  --accent:#ffb347;
  --accent-2:#5cf0a5;
  --line:#212840;
  --shadow:0 12px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter, "Helvetica Neue", Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 500px at 10% -10%, #243052 0%, rgba(36,48,82,0) 60%),
    radial-gradient(900px 400px at 90% 0%, #2a1f3f 0%, rgba(42,31,63,0) 55%),
    var(--bg);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}

.card{
  width:100%;
  max-width:520px;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:20px;
  padding:20px;
  box-shadow:var(--shadow);
  animation:fade .35s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1}
}

.title{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.title h2{
  margin:0;
  font-family:Fraunces, serif;
  font-size:24px;
}

.pill{
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  letter-spacing:.4px;
  text-transform:uppercase;
}

.pending{background:#2b2a1a;color:#f1c40f}
.accepted{background:#1f2a3d;color:#6fb5ff}
.ready{background:#193126;color:#5cf0a5}
.cancelled{background:#3a1f1f;color:#ff7a7a}

.meta{
  margin:10px 0 16px;
  color:var(--muted);
  font-size:13px;
}

.items{
  background:#0f1420;
  border-radius:14px;
  padding:12px;
  border:1px solid var(--line);
  margin:10px 0 14px;
  font-size:14px;
}

.items hr{
  border:none;
  border-top:1px solid var(--line);
  margin:10px 0;
}

.row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  color:var(--muted);
  font-size:14px;
}

.reply{
  background:#142417;
  color:#bfffd6;
  padding:10px;
  border-radius:12px;
  margin:12px 0 6px;
  font-weight:600;
  border:1px solid #21412b;
}

textarea{
  width:100%;
  border-radius:14px;
  padding:10px;
  border:1px solid var(--line);
  background:#0f1420;
  color:var(--text);
  margin-top:10px;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:22px;
  font-size:15px;
  cursor:pointer;
  font-weight:600;
}

.cancel{background:#e74c3c;color:#fff}
.edit{background:#ffb347;color:#0b0d12}
.send{background:#4b8bff;color:#fff}

.actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

@media (max-width:520px){
  .actions{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="card" id="box">
  Loading order...
</div>

<script>
const qs = new URLSearchParams(location.search);
const id = qs.get("id");
const apiParam = qs.get("api");
const API_BASE = apiParam ? decodeURIComponent(apiParam) : location.origin;

const box = document.getElementById("box");

function renderError(msg){
  box.innerHTML = `<h3 style="text-align:center">${msg}</h3>`;
}

async function fetchOrder(){
  if(!id){
    renderError("Order ID missing");
    return null;
  }

  let res = await fetch(`${API_BASE}/order/${id}`).catch(()=>null);
  if(!res || !res.ok){
    res = await fetch(`${API_BASE}/order?id=${id}`).catch(()=>null);
  }
  if(!res || !res.ok){
    renderError("Order not found or server not reachable");
    return null;
  }

  const data = await res.json().catch(()=>null);
  if(!data || !data.id){
    renderError("Invalid order data");
    return null;
  }

  return data;
}

async function loadStatus(){
  const o = await fetchOrder();
  if(!o) return;

  const statusText = o.status || "Pending";

  let statusClass =
    statusText==="Pending" ? "pending" :
    statusText==="Accepted" ? "accepted" :
    statusText==="Ready" ? "ready" :
    statusText==="Cancelled" ? "cancelled" : "pending";

  const items = JSON.parse(o.items || "[]")
    .map(i=>`${i.name} x ${i.qty}`)
    .join("<br>");

  const canCancel =
    statusText==="Pending" &&
    Date.now() < (o.can_modify_until || 0);

  box.innerHTML=`
    <div class="title">
      <h2>Order #${o.id}</h2>
      <div class="pill ${statusClass}">${statusText}</div>
    </div>
    <div class="meta">Date: ${o.date || "-"} | Time: ${o.time || "-"}</div>

    <div class="items">
      ${items || "No items"}
      <hr>
      <b>Total â‚¹${o.total || 0}</b>
    </div>

    <div class="row"><span>Name</span><span>${o.customer_name || "-"}</span></div>
    <div class="row"><span>Phone</span><span>${o.customer_phone || "-"}</span></div>

    ${o.kitchen_reply ? `
      <div class="reply">
        Kitchen: ${o.kitchen_reply}
      </div>
    ` : ""}

    ${canCancel ? `
      <div class="actions">
        <button class="cancel" onclick="cancelOrder()">Cancel Order</button>
        <button class="edit" onclick="editOrder()">Edit Order</button>
      </div>
    ` : ""}

    <textarea id="complaint" placeholder="Any issue or delay complaint?"></textarea>
    <button class="send" onclick="sendComplaint()">Send Complaint</button>
  `;
}

function cancelOrder(){
  fetch(`${API_BASE}/order/cancel`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id})
  }).then(loadStatus);
}

function editOrder(){
  alert("Edit allowed before accept.\nPlease reorder from menu.");
  location.href = "/";
}

function sendComplaint(){
  const text=document.getElementById("complaint").value.trim();
  if(!text)return alert("Enter complaint");

  fetch(`${API_BASE}/order/complaint`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id,text})
  }).then(()=>{
    alert("Complaint sent");
    document.getElementById("complaint").value="";
    loadStatus();
  });
}

loadStatus();
setInterval(loadStatus,3000);
</script>

</body>
</html>
