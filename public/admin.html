<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#0f0f0f;
  color:#fff;
}

header{
  background:#111;
  padding:16px;
  font-size:26px;
  text-align:center;
}

.summary{
  display:flex;
  justify-content:space-around;
  padding:16px;
  font-size:18px;
}

.actions{
  text-align:center;
  margin-bottom:10px;
}

.actions button{
  padding:8px 16px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  margin:0 6px;
}

.refreshBtn{background:#3498db;color:#fff}
.logoutBtn{background:#e74c3c;color:#fff}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:10px;
  border-bottom:1px solid #333;
  text-align:center;
}

th{background:#1e1e1e}

.paid{color:#2ecc71}
.unpaid{color:#e74c3c}

.complaint{color:#f1c40f;font-size:14px}

.msg{
  text-align:center;
  margin:16px 0;
  color:#f1c40f;
}

.debug{
  font-size:12px;
  color:#aaa;
  text-align:center;
  margin-bottom:10px;
}

#loginBox{
  max-width:320px;
  margin:20px auto;
  background:#1e1e1e;
  padding:16px;
  border-radius:12px;
}

#loginBox input, #loginBox button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  font-size:15px;
}

#loginBox button{
  background:#2ecc71;
  color:#000;
  cursor:pointer;
}
</style>
</head>

<body>

<header>ðŸ“Š Admin Dashboard</header>

<div id="loginBox" style="display:none">
  <h3 style="text-align:center;margin:6px 0">Admin Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button type="button" onclick="doLogin()">Login</button>
  <div id="loginMsg" class="msg"></div>
</div>

<div class="summary" id="summary" style="display:none">
  <div>Total Orders: <span id="count">0</span></div>
  <div>UPI â‚¹<span id="upi">0</span></div>
  <div>Cash â‚¹<span id="cash">0</span></div>
</div>

<div class="actions" id="actions" style="display:none">
  <button class="refreshBtn" onclick="loadAdmin()">Refresh Now</button>
  <button class="logoutBtn" onclick="doLogout()">Logout</button>
</div>

<div id="msg" class="msg"></div>
<div id="debug" class="debug"></div>

<table id="reportTable" style="display:none">
<thead>
<tr>
  <th>ID</th>
  <th>Date</th>
  <th>Time</th>
  <th>Table</th>
  <th>Total</th>
  <th>Payment</th>
  <th>Status</th>
  <th>Complaint</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const msg = document.getElementById("msg");
const debug = document.getElementById("debug");
const loginBox = document.getElementById("loginBox");
const summary = document.getElementById("summary");
const reportTable = document.getElementById("reportTable");
const actions = document.getElementById("actions");

let refreshTimer = null;

function showMsg(text){
  msg.textContent = text || "";
}

function showDebug(text){
  debug.textContent = text || "";
}

function showLogin(show){
  loginBox.style.display = show ? "block" : "none";
}

function showReport(show){
  summary.style.display = show ? "flex" : "none";
  reportTable.style.display = show ? "table" : "none";
  actions.style.display = show ? "block" : "none";
}

function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadAdmin, 2 * 60 * 1000);
}

async function loadAdmin(){
  try{
    const r = await fetch("/admin/report",{credentials:"same-origin"});
    showDebug(`GET /admin/report â†’ ${r.status}`);
    if(!r.ok) throw new Error("unauthorized");

    const data = await r.json();
    if(!Array.isArray(data)){
      showLogin(true);
      showReport(false);
      showMsg("Login required.");
      return;
    }

    showLogin(false);
    showReport(true);
    showMsg("");

    let upi=0,cash=0;
    document.getElementById("count").innerText=data.length;

    const rows=document.getElementById("rows");
    rows.innerHTML="";

    data.forEach(o=>{
      if(o.payment==="UPI")upi+=o.total;
      else cash+=o.total;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>#${o.id}</td>
        <td>${o.date||"-"}</td>
        <td>${o.time||"-"}</td>
        <td>${o.table_no}</td>
        <td>â‚¹${o.total}</td>
        <td class="${o.payment==="UPI"?"paid":"unpaid"}">${o.payment}</td>
        <td>${o.status}</td>
        <td class="complaint">${o.complaint||"â€”"}</td>
      `;
      rows.appendChild(tr);
    });

    document.getElementById("upi").innerText=upi;
    document.getElementById("cash").innerText=cash;

    if(!data.length) showMsg("No orders yet");
    startAutoRefresh();
  }catch{
    showLogin(true);
    showReport(false);
    showMsg("Login required.");
  }
}

function doLogin(){
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const loginMsg = document.getElementById("loginMsg");

  if(!username || !password){
    loginMsg.textContent = "Enter username and password";
    return;
  }

  fetch("/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials:"include",
    body:JSON.stringify({username,password})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success || d.role!=="admin"){
      loginMsg.textContent = "Invalid admin login";
      return;
    }
    loginMsg.textContent = "";
    loadAdmin();
  })
  .catch(()=>{
    loginMsg.textContent = "Server error";
  });
}

function doLogout(){
  fetch("/logout",{method:"POST",credentials:"same-origin"})
    .then(()=>{
      if(refreshTimer) clearInterval(refreshTimer);
      showLogin(true);
      showReport(false);
      showMsg("Logged out.");
    });
}

loadAdmin();
</script>

</body>
</html>
